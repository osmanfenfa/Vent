{% extends 'base.html' %}

{% block title %}Complaint Details - Vent System{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="mb-2">
                                <i class="fas fa-file-alt text-primary me-2"></i>
                                Complaint #{{ complaint.id }}
                            </h1>
                            <p class="text-muted mb-0">{{ complaint.title }}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="status-badge status-{{ complaint.status }} fs-6">
                                {{ complaint.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Main Content -->
                <div class="col-md-8">
                    <!-- Complaint Details -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Complaint Details
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Type:</strong>
                                    {% if complaint.type == 'anonymous' %}
                                        <span class="badge bg-success ms-2">
                                            <i class="fas fa-user-secret me-1"></i>Anonymous
                                        </span>
                                    {% else %}
                                        <span class="badge bg-primary ms-2">
                                            <i class="fas fa-user me-1"></i>Non-Anonymous
                                        </span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <strong>Category:</strong>
                                    <span class="badge bg-secondary ms-2">{{ complaint.get_category_display }}</span>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Submitted:</strong>
                                    <span class="ms-2">{{ complaint.created_at|date:"F d, Y \a\t g:i A" }}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Last Updated:</strong>
                                    <span class="ms-2">{{ complaint.updated_at|date:"F d, Y \a\t g:i A" }}</span>
                                </div>
                            </div>

                            {% if complaint.assigned_to %}
                            <div class="row mb-3">
                                <div class="col-12">
                                    <strong>Assigned To:</strong>
                                    <span class="badge bg-info ms-2">{{ complaint.assigned_to }}</span>
                                </div>
                            </div>
                            {% endif %}

                            <hr>

                            <div class="mb-3">
                                <strong>Description:</strong>
                                <div class="mt-2 p-3 bg-light rounded">
                                    {{ complaint.description|linebreaks }}
                                </div>
                            </div>

                            {% if complaint.attachment %}
                            <div class="mb-3">
                                <strong>Attachment:</strong>
                                <div class="mt-2">
                                    <a href="{{ complaint.attachment.url }}" class="btn btn-outline-primary" target="_blank">
                                        <i class="fas fa-download me-2"></i>
                                        Download {{ complaint.attachment.name|slice:"-20:" }}
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Student Information (for non-anonymous complaints) -->
                    {% if complaint.type == 'non_anonymous' and complaint.student %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-user me-2"></i>
                                Student Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Name:</strong>
                                    <span class="ms-2">{{ complaint.student.profile.full_name|default:complaint.student.get_full_name|default:complaint.student.username }}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Email:</strong>
                                    <span class="ms-2">{{ complaint.student.email }}</span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <strong>Student ID:</strong>
                                    <span class="ms-2">{{ complaint.student.profile.student_id|default:"Not provided" }}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>ID Number:</strong>
                                    <span class="ms-2">{{ complaint.student.id }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Sidebar -->
                <div class="col-md-4">
                    <!-- Status Update (Admin Only) -->
                    {% if is_admin %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-edit me-2"></i>
                                Update Status
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                                    {{ form.status }}
                                </div>
                                <div class="mb-3">
                                    <label for="{{ form.assigned_to.id_for_label }}" class="form-label">Assign To</label>
                                    {{ form.assigned_to }}
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-save me-2"></i>Update
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endif %}

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-bolt me-2"></i>
                                Quick Actions
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                {% if is_admin %}
                                    <button class="btn btn-outline-primary" onclick="printComplaint()">
                                        <i class="fas fa-print me-2"></i>Print
                                    </button>
                                    <button class="btn btn-outline-success" onclick="exportComplaint()">
                                        <i class="fas fa-download me-2"></i>Export
                                    </button>
                                {% endif %}
                                
                                <a href="{% url 'student_dashboard' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-home me-2"></i>Dashboard
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 500;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-in-progress {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    
    .status-resolved {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-closed {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #e9ecef;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }
    
    .timeline-marker {
        position: absolute;
        left: -22px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 0 0 2px #e9ecef;
    }
    
    .timeline-content {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border-radius: 8px;
        border-left: 3px solid #007bff;
    }
    
    .card {
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .form-control {
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }
    
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function printComplaint() {
        window.print();
    }
    
    function exportComplaint() {
        // This would typically generate a PDF or export the complaint data
        alert('Export functionality would be implemented here');
    }
</script>
{% endblock %}